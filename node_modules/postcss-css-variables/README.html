<h1>PostCSS CSS Variables</h1><p><a href="http://badge.fury.io/js/postcss-css-variables"><img src="https://badge.fury.io/js/postcss-css-variables.svg" alt="npm version"></a> <a href="https://travis-ci.org/MadLittleMods/postcss-css-variables"><img src="https://travis-ci.org/MadLittleMods/postcss-css-variables.svg" alt="Build Status"></a> <a href="https://gitter.im/MadLittleMods/postcss-css-variables?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge"><img src="https://badges.gitter.im/MadLittleMods/postcss-css-variables.svg" alt="Gitter"></a></p>
<p><a href="https://github.com/postcss/postcss">PostCSS</a> plugin to transform <a href="http://dev.w3.org/csswg/css-variables/"><code>CSS Custom Properties (CSS variables)</code></a> syntax into a static representation. This plugin provides a future-proof way of using <strong>most</strong> of CSS variables features, including selector cascading with some caveats, because this can only see the CSS, not the potentially dynamic HTML and DOM the CSS is applied to.</p>
<h3>Install</h3><pre><code>npm install postcss-css-variables --save-dev
</code></pre><h3>Table of Contents</h3><ul>
<li><a href="#code-playground">Code Playground</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#syntax">Syntax</a><ul>
<li><a href="#defining-custom-properties-with---">Defining Custom Properties with <code>--*</code></a></li>
<li><a href="#using-variables-custom-properties-with-var">Using Variables/Custom Properties with <code>var()</code></a></li>
</ul>
</li>
<li><a href="#features">Features</a><ul>
<li><a href="#at-rules-like-media-support-etc">At-rules like <code>@media</code>, <code>@support</code>, etc.</a></li>
<li><a href="#pseudo-classes-and-elements">Pseudo-classes and Elements</a></li>
<li><a href="#nested-rules">Nested Rules</a></li>
<li><a href="#calc"><code>calc()</code></a></li>
</ul>
</li>
<li><a href="#why">Why?</a><ul>
<li><a href="#interoperability">Interoperability</a></li>
<li><a href="#differences-from-postcss-custom-properties">Differences from <code>postcss-custom-properties</code></a></li>
</ul>
</li>
<li><a href="#caveats">Caveats</a></li>
<li><a href="#options">Options</a></li>
<li><a href="#quick-referencenotes">Quick Reference/Notes</a></li>
<li><a href="#testing">Testing</a></li>
<li><a href="https://github.com/MadLittleMods/postcss-css-variables/blob/master/CHANGELOG.md">Changelog</a></li>
</ul>
<h1><a href="https://madlittlemods.github.io/postcss-css-variables/playground/">Code Playground</a></h1><p><a href="https://madlittlemods.github.io/postcss-css-variables/playground/">Try it in the playground</a> and see what you think! Just add some CSS and see to see the final transformed/compiled CSS. You can try anything here in the playground, too.</p>
<h1>Usage</h1><p><a href="https://github.com/postcss/postcss#usage"><em>For more general PostCSS usage, look here.</em></a></p>
<pre><code class="language-js">var postcss = require(&#39;postcss&#39;);
var cssvariables = require(&#39;postcss-css-variables&#39;);

var fs = require(&#39;fs&#39;);

var mycss = fs.readFileSync(&#39;input.css&#39;, &#39;utf8&#39;);

// Process your CSS with postcss-css-variables
var output = postcss([
        cssvariables(/*options*/)
    ])
    .process(mycss)
    .css;

console.log(output);
</code></pre>
<h1>Syntax</h1><h3>Defining Custom Properties with <code>--*</code></h3><p>A custom property is any property whose name starts with two dashes <code>--</code>. A property must be in a rule.</p>
<p><em>Note: <code>:root</code> is nothing more than the selector for the root DOM node. Any other selector like <code>.class</code>, <code>#id</code>, or even <code>#foo ~ .bar &gt; span.baz</code> works.</em></p>
<pre><code class="language-css">:root {
    --foo-width: 100px;
    --foo-bg-color: rgba(255, 0, 0, 0.85);
}

.foo {
    --foo-width: 100px;
    --foo-bg-color: rgba(255, 0, 0, 0.85);
}
</code></pre>
<p>Custom properties can be declared multiple times, but like variable scope in other languages, only the most specific one takes precedence.</p>
<pre><code class="language-css">:root {
    --some-color: red;
}

.foo {
    /* red */
    color: var(--some-color);
}


.bar {
    --some-color: blue;
    /* blue */
    color: var(--some-color);
}

.bar:hover {
    --some-color: green;
    /* Automically gets a `color: green;` declaration because we `--some-color` used within scope elsewhere */
}
</code></pre>
<p><em><a href="http://dev.w3.org/csswg/css-variables/#defining-variables">W3C Draft: CSS Custom Properties for Cascading Variables, section 2</a></em></p>
<h3>Using Variables/Custom Properties with <code>var()</code></h3><pre><code class="language-css">.foo {
    width: var(--foo-width);
    /* You can even provide a fallback */
    background: var(--foo-bg-color, #ff0000);
}
</code></pre>
<p><em><a href="http://dev.w3.org/csswg/css-variables/#using-variables">W3C Draft: CSS Custom Properties for Cascading Variables, section 3</a></em></p>
<h1>Features</h1><h3>At-rules like <code>@media</code>, <code>@support</code>, etc.</h3><p>It&#39;s perfectly okay to declare CSS variables inside media queries and the like. It&#39;ll work just as you would expect.</p>
<pre><code class="language-css">:root {
    --width: 100px;
}

@media (max-width: 1000px) {
    :root {
        --width: 200px;
    }
}

.box {
    width: var(--width);
}
</code></pre>
<p>Will be transformed to:</p>
<pre><code class="language-css">.box {
    width: 100px;
}

@media (max-width: 1000px) {
    .box {
        width: 200px;
    }
}
</code></pre>
<h3>Pseudo-classes and Elements</h3><p>Psuedo-classes are also dealt with correctly, because it&#39;s easy to statically determine.</p>
<pre><code class="language-css">.foo {
    --foo-color: red;
    color: var(--foo-color);
}

.foo:hover {
    --foo-color: green;
}
</code></pre>
<p>Will be transformed to:</p>
<pre><code class="language-css">.foo {
    color: red;
}

.foo:hover {
    color: green;
}
</code></pre>
<h3>Nested Rules</h3><p>This pairs very well with <a href="https://github.com/postcss/postcss-nested"><code>postcss-nested</code></a> or <a href="https://github.com/jonathantneal/postcss-nesting"><code>postcss-nesting</code></a>, adding support for nested rules. For either, you must put the plugin before <code>postcss-css-variables</code> in the plugin stack so that the <code>&amp;</code> references are expanded first (<code>postcss-css-variables</code> doesn&#39;t understand them). For example, with <code>postcss-nested</code>, your PostCSS setup would look like this:</p>
<pre><code class="language-js">var postcss = require(&#39;postcss&#39;);
var cssvariables = require(&#39;postcss-css-variables&#39;);
var nested = require(&#39;postcss-nested&#39;);

var fs = require(&#39;fs&#39;);

var mycss = fs.readFileSync(&#39;input.css&#39;, &#39;utf8&#39;);

var output = postcss([
        // Flatten/unnest rules
        nested,
        // Then process any CSS variables
        cssvariables(/*options*/)
    ])
    .process(mycss)
    .css;

console.log(output);
</code></pre>
<p>For a simple example with nesting:</p>
<pre><code class="language-css">.box-foo {
    --some-width: 150px;
    width: var(--some-width);

    .box-bar {
        width: var(--some-width);
    }
}
</code></pre>
<p>With also <code>postcss-nesting</code>, this will be transformed to:</p>
<pre><code class="language-css">.box-foo {
    width: 150px;
}

.box-foo .box-bar {
    width: 150px;
}
</code></pre>
<p>For a more complex example with a media query:</p>
<pre><code class="language-css">:root {
    --some-width: 150px;
}

.box-foo {
    width: var(--some-width);

    .box-bar {
        width: var(--some-width);
    }
}

@media (max-width: 800px) {
    .box-foo {
        --some-width: 300px;
    }
}
</code></pre>
<p>Will be transformed to:</p>
<pre><code class="language-css">.box-foo {
    width: 150px;
}

.box-foo .box-bar {
    width: 150px;
}

@media (max-width: 800px) {
    .box-foo {
        width: 300px;
    }

    .box-foo .box-bar {
        width: 300px;
    }
}
</code></pre>
<h1>Why?</h1><p>This plugin was spawned out of a <a href="https://github.com/cssnext/cssnext/issues/99">discussion on the <code>cssnext</code> repo</a> and a personal need.</p>
<p>There is another similar plugin available, <a href="https://github.com/postcss/postcss-custom-properties"><code>postcss-custom-properties</code></a>, although it restricts itself much more than this plugin, preferring partial spec conformance. This plugin has the same capabilities but also adds imperfect feature support which stem from not being to know what the DOM will look like when you compile your CSS. We instead look at the explicit structure of your CSS selectors.</p>
<h3>Interoperability</h3><p>Putting <code>postcss-css-variables</code> in place of <code>postcss-custom-properties</code> should work out of the box.</p>
<p>In <code>postcss-custom-properties</code>, CSS variable declarations are specifically restricted to the <code>:root</code> selector. In <code>postcss-css-variables</code>, this is not the case and they may be declared inside any rule with whatever selector. The variables are substituted based on statically known CSS selector inheritance.</p>
<h3>Differences from <code>postcss-custom-properties</code></h3><p>In <a href="https://github.com/postcss/postcss-custom-properties"><code>postcss-custom-properties</code></a>, CSS variable declarations are specifically restricted to the <code>:root</code> selector. In <code>postcss-css-variables</code>, this is not the case and they may be declared inside any rule with whatever selector.</p>
<p>Here&#39;s a quick overview of the differences:</p>
<ul>
<li>CSS variables may be declared in any selector like <code>.foo</code> or <code>.foo .bar:hover</code>, and is not limited to just <code>:root</code></li>
<li>CSS variables may be declared in <code>@media</code>, <code>@support</code>, and other at-rules.</li>
<li>CSS variables may be declared in <code>:hover</code> and other psuedo-classes, which get expanded properly.</li>
<li>Variables in nested rules can be deduced with the help of <a href="https://github.com/postcss/postcss-nested"><code>postcss-nested</code></a> or <a href="https://github.com/jonathantneal/postcss-nesting"><code>postcss-nesting</code></a>.</li>
</ul>
<p>Continue to the next section to see where some of these might be unsafe to do. There are reasons behind the ethos of why the other plugin, <a href="https://github.com/postcss/postcss-custom-properties"><code>postcss-custom-properties</code></a>, is very limited in what it supports, due to differing opinions on what is okay to support.</p>
<h1>Caveats</h1><p>When you declare a CSS variable inside one selector, but consume it in another, this does make an unsafe assumption about it which can be non-conforming in certain edge cases. Here is an example where these limitations result in non-conforming behavior.</p>
<p>Using the following CSS:</p>
<pre><code class="language-css">.component {
  --text-color: blue;
}

.component .header {
  color: var(--text-color);
}

.component .text {
  --text-color: green;
  color: var(--text-color);
}
</code></pre>
<p>Note the nested markup below. We only know about the DOM&#39;s inheritance from your CSS selectors. If you want nest multiple times, you need to be explicit about it in your CSS which isn&#39;t necessary with browser that natively support CSS variables. See the innermost <code>&lt;h1 class=&quot;title&quot;&gt;</code></p>
<pre><code class="language-html">&lt;div class=&quot;component&quot;&gt;
    Black

    &lt;h1 class=&quot;title&quot;&gt;
        Blue

        &lt;p class=&quot;decoration&quot;&gt;
            Green

            &lt;h1 class=&quot;title&quot;&gt;Blue with this plugin, but green per spec&lt;/h1&gt;
        &lt;/p&gt;
    &lt;/h1&gt;
&lt;/div&gt;
</code></pre>
<p><a href="https://github.com/postcss/postcss-custom-properties"><code>postcss-custom-properties</code></a> avoids this problem entirely by restricting itself to just the <code>:root</code> selector. This is because the developers there would prefer to not support a feature instead of something almost-spec-compliant like what <code>postcss-css-variables</code> does.</p>
<h1>Options</h1><h3><code>preserve</code> (default: <code>false</code>)</h3><p>Allows you to preserve custom properties &amp; var() usage in output.</p>
<p>Possible values:</p>
<ul>
<li><code>false</code>: Removes <code>--var</code> declarations and replaces <code>var()</code> with their resolved/computed values.</li>
<li><code>true</code>: Keeps <code>var()</code> declarations in the output and has the computed value as a fallback declaration. Also keeps computed <code>--var</code> declarations.</li>
<li><code>&#39;computed&#39;</code>: Keeps computed <code>--var</code> declarations in the output. Handy to make them available to your JavaScript.</li>
</ul>
<h3><code>variables</code> (default: <code>{}</code>)</h3><p>Define an object map of variables in JavaScript that will be declared at the <code>:root</code> scope.</p>
<p>Can be a simple key-value pair or an object with a <code>value</code> property and an optional <code>isImportant</code> bool property.</p>
<p>The object keys are automatically prefixed with <code>--</code> (according to CSS custom property syntax) if you do not provide it.</p>
<pre><code class="language-js">var postcss = require(&#39;postcss&#39;);
var cssvariables = require(&#39;postcss-css-variables&#39;);

postcss([
    cssvariables({
        variables: {
            &#39;--some-var&#39;: &#39;100px&#39;,
            &#39;--other-var&#39;: {
                value: &#39;#00ff00&#39;
            },
            &#39;--important-var&#39;: {
                value: &#39;#ff0000&#39;,
                isImportant: true
            }
        }
    })
])
.process(css, opts);
</code></pre>
<h1>Quick Reference/Notes</h1><ul>
<li>This plugin was spawned out of a <a href="https://github.com/cssnext/cssnext/issues/99">discussion on the <code>cssnext</code> repo</a></li>
<li>We provide a larger CSS variable feature subset than <a href="https://github.com/postcss/postcss-custom-properties"><code>postcss-custom-properties</code></a>.</li>
<li>Related links and issues:<ul>
<li><a href="https://github.com/cssnext/cssnext/issues/99">var declared in media query should pull in properties that use/reference that var <em>on <code>cssnext/cssnext</code></em></a></li>
<li><a href="https://github.com/postcss/postcss-custom-properties/issues/9">Investigate support for media-query scoped properties <em>on <code>postcss/postcss-custom-properties</code></em></a></li>
<li><a href="https://github.com/postcss/postcss-custom-properties/issues/1">remove <code>:root</code> limitation by injecting rules with new declarations that just contains modified properties. <em>on <code>postcss/postcss-custom-properties</code></em></a></li>
</ul>
</li>
</ul>
<h1>Testing</h1><p>We have a suite of <a href="http://mochajs.org/">Mocha</a> tests. If you see something that doesn&#39;t have coverage, make an issue or pull request.</p>
<p>Run once:</p>
<p><code>npm install</code></p>
<p>Run whenever you want to test:</p>
<p><code>npm run test</code></p>
